<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.io.*, java.util.*, javax.servlet.http.*" %>
<%@ page import="com.app.util.QuestionFileParser" %>
<%@ page import="com.app.pojos.Question" %>
<%@ page import="com.app.daos.QuestionDaoImp" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<!DOCTYPE html>
<html>
<head><title>Processing Quiz</title></head>
<body>
<%
    try {
        // 1. Get the file part from the multipart request
        Part filePart = request.getPart("filename"); 
        String title = request.getParameter("title");
        String userIdStr = request.getParameter("user_id");

        if (filePart != null && filePart.getSize() > 0) {
            // 2. Create a temporary file on the server to satisfy QuestionFileParser's File requirement
            String tempPath = application.getRealPath("/") + "temp_questions.txt";
            File tempFile = new File(tempPath);

            // 3. Write the uploaded data to the temp file
            try (InputStream is = filePart.getInputStream(); 
                 FileOutputStream os = new FileOutputStream(tempFile)) {
                byte[] buffer = new byte[1024];
                int bytesRead;
                while ((bytesRead = is.read(buffer)) != -1) {
                    os.write(buffer, 0, bytesRead);
                }
            }

            // 4. Use your existing Parser with the temporary File path
            List<Question> questions = QuestionFileParser.parse(tempFile);

            // 5. Store the questions in the session or database
            // (Example: Logic to save the Quiz first to get a Quiz ID, then save questions)
            
            out.println("<h3>Success! Found " + questions.size() + " questions.</h3>");
            out.println("<p>Quiz Title: " + title + "</p>");

            // Cleanup: Delete temp file
            tempFile.delete();
        } else {
            out.println("<h3 style='color:red;'>Error: No file selected.</h3>");
        }
    } catch (Exception e) {
        out.println("<h3 style='color:red;'>Error: " + e.getMessage() + "</h3>");
        e.printStackTrace();
    }
%>
<a href="quizlist.jsp">View All Quizzes</a>
</body>
</html>